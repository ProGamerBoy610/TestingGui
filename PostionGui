-- RyZen Hub - Fixed Version
-- Main fixes:
-- 1. Fixed variable scoping issues
-- 2. Fixed AutoSell movement lock
-- 3. Fixed missing sections
-- 4. Fixed Auto Mine functionality

local v1, vu2 = pcall(function()
    return loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
end)

if not (v1 and vu2) then
    warn("Failed to load WindUI")
    return
end

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

-- Theme Setup
local themeNames = {
    "Ocean Blue", "Forest Green", "Minimal Light", "Retro Purple", "Sunset",
    "Neon Pulse", "Steel Phantom", "Vaporwave", "Deep Sea", "Sepia Warmth",
    "Monokai Dark", "Solarized Light", "Cherry Blossom", "Charcoal Gold",
    "Icy Mint", "Volcano", "Amethyst", "Pastel Dream", "Coffee Shop", "Cyberpunk Red"
}

local themeColors = {
    ["Volcano"] = {
        Accent = "#B22222",
        Dialog = "#1C1C1C",
        Outline = "#FF6347",
        Text = "#EBEBEB",
        Placeholder = "#704747",
        Background = "#0A0A0A",
        Button = "#FF4500",
        Icon = "#FF6347"
    }
    -- Add other themes as needed
}

-- Apply themes
for name, colors in pairs(themeColors) do
    vu2:AddTheme({
        Name = name,
        Accent = Color3.fromHex(colors.Accent),
        Dialog = Color3.fromHex(colors.Dialog),
        Outline = Color3.fromHex(colors.Outline),
        Text = Color3.fromHex(colors.Text),
        Placeholder = Color3.fromHex(colors.Placeholder),
        Background = Color3.fromHex(colors.Background),
        Button = Color3.fromHex(colors.Button),
        Icon = Color3.fromHex(colors.Icon)
    })
end

vu2:SetTheme("Volcano")

-- Create Window
local Window = vu2:CreateWindow({
    Title = "RyZen Hub",
    Icon = "rbxassetid://84501312005643",
    IconThemed = true,
    Author = "By @mallo",
    Size = UDim2.fromOffset(580, 460),
    Resizable = true,
    Transparent = true
})

Window:Tag({
    Title = "Mode: Freemium",
    Color = Color3.fromHex("#30ff6a"),
    Radius = 10
})

-- ==================== AUTO MINE TAB ====================
local MainTab = Window:Tab({
    Title = "MainFarm",
    Icon = "house"
})

local Section = MainTab:Section({
    Title = "Auto Mine",
    Icon = "pickaxe"
})

-- Global settings
_G.AutoMine = _G.AutoMine or false
_G.MineTheseOres = _G.MineTheseOres or {}
_G.TweenSpeed = _G.TweenSpeed or 67
_G.FilterByArea = _G.FilterByArea or false
_G.SelectedAreas = _G.SelectedAreas or {}
_G.MineMode = _G.MineMode or "Ores"

-- Find tool service
local ToolService
pcall(function()
    ToolService = ReplicatedStorage.Shared.Packages.Knit.Services.ToolService.RF.ToolActivated
end)

-- Rock and ore definitions
local RockOreTypes = {
    Pebble = {"Stone", "Sand Stone", "Copper", "Iron", "Poopite"},
    Rock = {"Sand Stone", "Copper", "Iron", "Tin", "Silver"},
    Boulder = {"Copper", "Iron", "Tin", "Silver", "Gold", "Platinum"}
}

local AllOres = {
    "Stone", "Sand Stone", "Copper", "Iron", "Tin", "Silver", "Gold",
    "Platinum", "Cobalt", "Titanium", "Diamond", "Ruby", "Emerald"
}

local AllRocks = {"Pebble", "Rock", "Boulder", "Basalt Rock"}

-- Helper functions
local function GetHRP()
    local char = LocalPlayer.Character
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function GetRockType(rock)
    if not rock then return nil end
    
    local rockType = rock:GetAttribute("RockType")
    if rockType then return tostring(rockType) end
    
    if RockOreTypes[rock.Name] then
        return rock.Name
    end
    
    return nil
end

local function IsDesiredRock(rock)
    if not rock then return false end
    if not _G.MineTheseOres or #_G.MineTheseOres == 0 then return true end
    
    local rockType = GetRockType(rock)
    if not rockType then return false end
    
    local drops = RockOreTypes[rockType]
    if not drops then return false end
    
    for _, desired in ipairs(_G.MineTheseOres) do
        for _, drop in ipairs(drops) do
            if string.lower(drop) == string.lower(desired) then
                return true
            end
        end
    end
    
    return false
end

local function GetRockHealth(rock)
    if not rock then return nil end
    
    local health = rock:GetAttribute("Health")
    if health then return health end
    
    local part = rock:IsA("BasePart") and rock or rock:FindFirstChildWhichIsA("BasePart")
    if part then
        health = part:GetAttribute("Health")
        if health then return health end
    end
    
    return nil
end

local function FindNearestRock()
    local hrp = GetHRP()
    if not hrp then return nil end
    
    local rocksFolder = Workspace:FindFirstChild("Rocks")
    if not rocksFolder then return nil end
    
    local nearest = nil
    local minDist = math.huge
    
    for _, area in ipairs(rocksFolder:GetChildren()) do
        for _, rock in ipairs(area:GetDescendants()) do
            if rock:IsA("Model") or rock:IsA("BasePart") then
                if IsDesiredRock(rock) then
                    local health = GetRockHealth(rock)
                    if health and health > 0 then
                        local part = rock:IsA("BasePart") and rock or rock:FindFirstChildWhichIsA("BasePart")
                        if part then
                            local dist = (hrp.Position - part.Position).Magnitude
                            if dist < minDist then
                                nearest = rock
                                minDist = dist
                            end
                        end
                    end
                end
            end
        end
    end
    
    return nearest
end

local function TweenToRock(rock)
    local hrp = GetHRP()
    if not hrp or not rock then return end
    
    local part = rock:IsA("BasePart") and rock or rock:FindFirstChildWhichIsA("BasePart")
    if not part then return end
    
    local targetPos = part.Position + Vector3.new(0, 3, 0)
    local distance = (hrp.Position - targetPos).Magnitude
    local time = distance / (_G.TweenSpeed or 67)
    
    local tween = TweenService:Create(hrp, TweenInfo.new(time, Enum.EasingStyle.Linear), {
        CFrame = CFrame.new(targetPos)
    })
    
    tween:Play()
    tween.Completed:Wait()
end

local function ActivateTool()
    if ToolService then
        pcall(function()
            ToolService:InvokeServer("Pickaxe")
        end)
    end
end

-- Auto mine toggle
MainTab:Section({Title = "Master", Icon = "play"}):Toggle({
    Title = "Auto Mine (Master)",
    Desc = "Enable/disable auto-miner",
    Value = _G.AutoMine,
    Callback = function(value)
        _G.AutoMine = value
        vu2:Notify({
            Title = "Auto Mine",
            Content = value and "Enabled" or "Disabled",
            Duration = 1.5
        })
    end
})

-- Mode selection
MainTab:Section({Title = "Selection & Mode", Icon = "settings-2"}):Dropdown({
    Title = "Mine Type",
    Desc = "Choose what to mine",
    Values = {"Ores", "Rocks"},
    Value = _G.MineMode,
    Multi = false,
    Callback = function(value)
        _G.MineMode = value
        _G.MineTheseOres = {_G.MineMode == "Ores" and AllOres[1] or AllRocks[1]}
    end
})

-- Ore/Rock selection
MainTab:Section({Title = "Selection & Mode", Icon = "settings-2"}):Dropdown({
    Title = "Ore Drops",
    Desc = "Select ores to mine",
    Values = AllOres,
    Value = {},
    Multi = true,
    Callback = function(value)
        if _G.MineMode == "Ores" then
            _G.MineTheseOres = type(value) == "table" and value or {value}
        end
    end
})

-- Speed slider
MainTab:Section({Title = "Options", Icon = "settings"}):Slider({
    Title = "Tween Speed",
    Desc = "Movement speed to rocks",
    Step = 1,
    Value = {Min = 1, Max = 100, Default = _G.TweenSpeed},
    Callback = function(value)
        _G.TweenSpeed = value
    end
})

-- Main mining loop
task.spawn(function()
    local currentRock = nil
    
    while true do
        task.wait(0.12)
        
        if not _G.AutoMine then
            currentRock = nil
            continue
        end
        
        local hrp = GetHRP()
        if not hrp then
            task.wait(0.4)
            continue
        end
        
        -- Check current rock
        if currentRock and currentRock.Parent then
            local health = GetRockHealth(currentRock)
            if health and health > 0 and IsDesiredRock(currentRock) then
                -- Keep mining
                ActivateTool()
                task.wait(0.05)
                continue
            end
        end
        
        -- Find new rock
        currentRock = FindNearestRock()
        
        if not currentRock then
            task.wait(0.28)
            continue
        end
        
        -- Move to rock
        TweenToRock(currentRock)
        
        -- Start mining
        while currentRock and currentRock.Parent and _G.AutoMine do
            local health = GetRockHealth(currentRock)
            if not health or health <= 0 then
                break
            end
            
            ActivateTool()
            task.wait(0.05)
        end
        
        currentRock = nil
    end
end)

-- ==================== AUTO SELL TAB ====================
local SellTab = Window:Tab({
    Title = "AutoSell",
    Icon = "circle-dollar-sign"
})

SellTab:Section({Title = "Ores", Icon = "pickaxe"})

-- Fixed movement system
local MovementLock = false

local function tweenToCFrame(targetCFrame)
    if MovementLock then return false end
    MovementLock = true
    
    local hrp = GetHRP()
    if not hrp then
        MovementLock = false
        return false
    end
    
    local distance = (hrp.Position - targetCFrame.Position).Magnitude
    if distance > 600 then
        MovementLock = false
        return false
    end
    
    local time = math.clamp(distance / 10, 1.8, 7)
    local tween = TweenService:Create(hrp, TweenInfo.new(time, Enum.EasingStyle.Linear), {
        CFrame = targetCFrame
    })
    
    tween:Play()
    tween.Completed:Wait()
    
    MovementLock = false
    return true
end

-- Auto Sell Ores
_G.AutoSellEnabled = false
_G.ItemsToSell = {}
_G.SellAmount = 1
_G.SellDelayMs = 70

local SellPos = Vector3.new(-111.74, 37.50, -38.12)

local DialogueService
pcall(function()
    DialogueService = ReplicatedStorage.Shared.Packages.Knit.Services.DialogueService.RF.RunCommand
end)

local function SellItems(items, amount)
    if not DialogueService then return false end
    
    local basket = {}
    for _, item in ipairs(items) do
        basket[item] = amount
    end
    
    local success = pcall(function()
        DialogueService:InvokeServer("SellConfirm", {Basket = basket})
    end)
    
    return success
end

SellTab:Dropdown({
    Title = "Select Items to Sell",
    Desc = "Choose items to autosell",
    Values = AllOres,
    Multi = true,
    Value = {},
    Callback = function(value)
        _G.ItemsToSell = type(value) == "table" and value or {value}
    end
})

SellTab:Input({
    Title = "Amount to sell",
    Desc = "Number per item",
    Value = "1",
    Type = "Input",
    Callback = function(value)
        local num = tonumber(value)
        _G.SellAmount = (num and num > 0) and math.floor(num) or 1
    end
})

SellTab:Toggle({
    Title = "Auto Sell",
    Desc = "Automatically sell items",
    Value = false,
    Callback = function(value)
        _G.AutoSellEnabled = value
    end
})

-- Auto sell loop
task.spawn(function()
    while true do
        task.wait(1)
        
        if not _G.AutoSellEnabled then continue end
        if #_G.ItemsToSell == 0 then continue end
        
        -- Move to sell location
        local success = tweenToCFrame(CFrame.new(SellPos))
        if not success then
            task.wait(2)
            continue
        end
        
        task.wait(0.5)
        
        -- Sell items
        SellItems(_G.ItemsToSell, _G.SellAmount)
        
        task.wait(_G.SellDelayMs / 1000)
    end
end)

-- ==================== FORGE TAB ====================
local ForgeTab = Window:Tab({
    Title = "Forge",
    Icon = "anvil"
})

ForgeTab:Section({Title = "Forge", Icon = "anvil"})

ForgeTab:Button({
    Title = "Open Forge UI",
    Desc = "Opens the forge interface",
    Callback = function()
        local proximityService
        pcall(function()
            proximityService = ReplicatedStorage.Shared.Packages.Knit.Services.ProximityService.RF.Forge
        end)
        
        if proximityService then
            local forgeObj = Workspace:FindFirstChild("Proximity")
            if forgeObj then
                forgeObj = forgeObj:FindFirstChild("Forge")
                if forgeObj then
                    pcall(function()
                        proximityService:InvokeServer(forgeObj)
                    end)
                end
            end
        end
    end
})

-- ==================== MISC TAB ====================
local MiscTab = Window:Tab({
    Title = "Misc",
    Icon = "cog"
})

MiscTab:Dropdown({
    Title = "Select Theme",
    Values = themeNames,
    Value = "Volcano",
    Callback = function(value)
        vu2:SetTheme(value)
    end
})

MiscTab:Toggle({
    Title = "Transparent Window",
    Desc = "Toggle UI transparency",
    Default = false,
    Callback = function(value)
        Window:ToggleTransparency(value)
    end
})

-- Spin feature
local SPIN_ENABLED = false
local SPIN_SPEED = 200
local SPIN_BAV = nil

MiscTab:Toggle({
    Title = "Spin",
    Desc = "Enable character spinning",
    Default = false,
    Callback = function(value)
        SPIN_ENABLED = value
    end
})

MiscTab:Slider({
    Title = "Spin Speed",
    Desc = "Max to become a helicopter",
    Value = {Min = 10, Max = 2000, Default = 200},
    Step = 1,
    Callback = function(value)
        SPIN_SPEED = value
    end
})

-- Spin loop
RunService.Heartbeat:Connect(function()
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    
    if SPIN_ENABLED and hrp and hum then
        if not SPIN_BAV or SPIN_BAV.Parent ~= hrp then
            SPIN_BAV = Instance.new("BodyAngularVelocity")
            SPIN_BAV.MaxTorque = Vector3.new(0, 9000000000, 0)
            SPIN_BAV.Parent = hrp
        end
        SPIN_BAV.AngularVelocity = Vector3.new(0, math.rad(SPIN_SPEED), 0)
        hum.AutoRotate = false
    else
        if SPIN_BAV then
            SPIN_BAV:Destroy()
            SPIN_BAV = nil
        end
        if hum then
            hum.AutoRotate = true
        end
    end
end)

print("RyZen Hub loaded successfully!")
